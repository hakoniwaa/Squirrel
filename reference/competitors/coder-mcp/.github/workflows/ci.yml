# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: "Run with debug logging"
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.13"           # primary; test matrix overrides
  POETRY_VERSION: "1.7.1"
  ENVIRONMENT: "test"
  LOG_LEVEL: "DEBUG"
  REDIS_HOST: "localhost"
  REDIS_PORT: "6379"
  REDIS_DB: "1"
  CACHE_ENABLED: "false"
  RATE_LIMIT_ENABLED: "false"
  CODER_MCP_TEST_MODE: "true"
  OPENAI_API_KEY: ${{ secrets.TEST_OPENAI_API_KEY || '' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# -----------------------------------------------------------------------------
# SETUP  – install Poetry & dependencies once; expose cache key + API-key flag
# -----------------------------------------------------------------------------
jobs:
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      has-openai-key: ${{ steps.check-secrets.outputs.has-openai-key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check secrets availability
        id: check-secrets
        run: |
          if [[ -n "${{ secrets.TEST_OPENAI_API_KEY }}" ]]; then
            echo "has-openai-key=true" >> "$GITHUB_OUTPUT"
            echo "✓ OpenAI API key available"
          else
            echo "has-openai-key=false" >> "$GITHUB_OUTPUT"
            echo "⚠ OpenAI API key NOT found – AI tests will be skipped"
          fi

      - name: Generate cache key
        id: cache-key
        run: |
          echo "key=venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Fix: Include Python version in Poetry cache key
      - name: Cache Poetry installation
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: poetry-${{ env.POETRY_VERSION }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies (if cache miss)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          poetry install --with dev,test --no-interaction --no-root

# -----------------------------------------------------------------------------
# LINT  – pre-commit / flake8 / pylint / Bandit (SARIF upload)
# -----------------------------------------------------------------------------
  lint:
    name: Lint
    continue-on-error: true
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Fix: Include Python version in Poetry cache key
      - uses: actions/cache@v4
        with:
          path: ~/.local
          key: poetry-${{ env.POETRY_VERSION }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}

      - uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ needs.setup.outputs.cache-key }}

      # Fix: Ensure dependencies are installed
      - name: Install dependencies
        run: poetry install --with dev,test --no-interaction --no-root

      - name: Run pre-commit
        run: poetry run pre-commit run --all-files --show-diff-on-failure

      - name: Run flake8
        run: poetry run flake8 coder_mcp tests

      - name: Run pylint
        run: poetry run pylint coder_mcp || true

      - name: Bandit security scan (SARIF)
        run: poetry run bandit -r coder_mcp -f sarif -o bandit-report.sarif || true

      - name: Check if SARIF file exists
        id: check-sarif
        run: |
          if [ -f "bandit-report.sarif" ]; then
            echo "sarif-exists=true" >> $GITHUB_OUTPUT
          else
            echo "sarif-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Bandit SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: steps.check-sarif.outputs.sarif-exists == 'true'
        continue-on-error: true
        with:
          sarif_file: bandit-report.sarif
          category: bandit

# -----------------------------------------------------------------------------
# TYPE-CHECK  – MyPy strict
# -----------------------------------------------------------------------------
  type-check:
    name: Type Check
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Fix: Include Python version in Poetry cache key
      - uses: actions/cache@v4
        with:
          path: ~/.local
          key: poetry-${{ env.POETRY_VERSION }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}

      - uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ needs.setup.outputs.cache-key }}

      # Fix: Ensure dependencies are installed
      - name: Install dependencies
        run: poetry install --with dev,test --no-interaction --no-root

      - name: Run MyPy (strict)
        run: poetry run mypy --strict coder_mcp --junit-xml=mypy-report.xml || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mypy-report
          path: mypy-report.xml
          retention-days: 7

# -----------------------------------------------------------------------------
# SECRETS SCAN  – TruffleHog
# -----------------------------------------------------------------------------
  security:
    name: Secrets Scan
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.before }}
          head: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
          extra_args: --only-verified

# -----------------------------------------------------------------------------
# TEST  – matrix (Ubuntu only, because service containers require Linux)
# -----------------------------------------------------------------------------
  test:
    name: Test ${{ matrix.python-version }}
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.13", "3.12", "3.11"]

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # Fix: Include Python version in Poetry cache key for matrix jobs
      - uses: actions/cache@v4
        with:
          path: ~/.local
          key: poetry-${{ env.POETRY_VERSION }}-${{ runner.os }}-py${{ matrix.python-version }}

      - uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Install dependencies
        run: poetry install --with dev,test --no-interaction --no-root

      - name: Generate test config
        run: |
          mkdir -p .coder-mcp
          cat > .coder-mcp/config.json <<'EOF'
          {
            "server": {"name": "test-server", "version": "1.0.0"},
            "ai": {"enabled": false},
            "providers": {
              "embedding": "local",
              "vector_store": "memory",
              "cache": "memory"
            }
          }
          EOF
          echo "CODER_MCP_CONFIG_PATH=$PWD/.coder-mcp/config.json" >> "$GITHUB_ENV"

      - name: Debug environment
        if: ${{ github.event.inputs.debug_enabled == 'true' }}
        run: |
          echo "=== Environment Variables ==="
          env | sort
          echo "=== Poetry Environment ==="
          poetry env info
          echo "=== Installed Packages ==="
          poetry show
          echo "=== Virtual Environment Check ==="
          which python
          which pytest

      - name: Run unit tests + coverage
        run: |
          poetry run pytest \
            --asyncio-mode=auto \
            --cov=coder_mcp --cov-report=xml --cov-report=html \
            --junit-xml=test-results.xml \
            -v --tb=short

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: test-results.xml
          retention-days: 7

      - uses: actions/upload-artifact@v4
        if: always() && matrix.python-version == '3.13'
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
          retention-days: 7

      - name: Upload coverage reports to Codecov
        if: matrix.python-version == '3.13'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: coder-mcp/coder-mcp

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: coder-mcp/coder-mcp

# -----------------------------------------------------------------------------
# INTEGRATION TESTS  – single job (3.13 + Redis)
# -----------------------------------------------------------------------------
  integration-test:
    name: Integration Tests
    needs: [setup, lint, type-check]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      INTEGRATION_TESTS: "true"
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      # Fix: Include Python version in Poetry cache key
      - uses: actions/cache@v4
        with:
          path: ~/.local
          key: poetry-${{ env.POETRY_VERSION }}-${{ runner.os }}-py3.13

      - uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      # Fix: Add cache restoration for dependencies
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.13-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-3.13-

      - name: Install dependencies
        run: poetry install --with dev,test --no-interaction --no-root

      - name: Generate integration-test config
        run: |
          mkdir -p .coder-mcp
          cat > .coder-mcp/config.json <<'EOF'
          {
            "server": {"name": "test-server", "version": "1.0.0"},
            "ai": {"enabled": false},
            "providers": {
              "embedding": "local",
              "vector_store": "redis",
              "cache": "redis"
            }
          }
          EOF
          echo "CODER_MCP_CONFIG_PATH=$PWD/.coder-mcp/config.json" >> "$GITHUB_ENV"

      - name: Run integration tests
        run: |
          poetry run pytest tests/integration \
            -m integration \
            --asyncio-mode=auto \
            -v --tb=short \
            --junit-xml=integration-test-results.xml || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: integration-test-results.xml
          retention-days: 7

# -----------------------------------------------------------------------------
# BUILD  – sdist + wheel
# -----------------------------------------------------------------------------
  build:
    name: Build Distribution
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      # Fix: Include Python version in Poetry cache key
      - uses: actions/cache@v4
        with:
          path: ~/.local
          key: poetry-${{ env.POETRY_VERSION }}-${{ runner.os }}-py3.13

      - uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      # Fix: Add cache restoration and dependency installation
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.13-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-3.13-

      - name: Install dependencies
        run: poetry install --with dev,test --no-interaction --no-root

      - name: Build package
        run: poetry build

      - name: Verify package
        run: |
          pip install twine
          twine check dist/*

      - uses: actions/upload-artifact@v4
        with:
          name: distribution
          path: dist/
          retention-days: 30

# -----------------------------------------------------------------------------
# GATE  – show a single success / failure
# -----------------------------------------------------------------------------
  all-checks-pass:
    name: All Checks Pass
    needs: [lint, type-check, security, test, integration-test, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}

      - name: Workflow summary
        run: |
          echo "## Workflow Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "| Job | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| lint | ${{ needs.lint.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| type-check | ${{ needs.type-check.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| security | ${{ needs.security.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| test | ${{ needs.test.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| integration-test | ${{ needs.integration-test.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| build | ${{ needs.build.result }} |" >> "$GITHUB_STEP_SUMMARY"
