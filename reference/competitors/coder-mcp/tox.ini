[tox]
envlist =
    py313-{unit,integration,e2e}
    lint
    type-check
    security
    docs
    coverage-report
isolated_build = True
skip_missing_interpreters = True

[testenv]
allowlist_externals = poetry
commands_pre =
    poetry install --no-interaction --with test
passenv =
    TEST_*
    REDIS_URL
    OPENAI_API_KEY
    CI
    GITHUB_*

[testenv:py313-unit]
description = Run unit tests
commands =
    poetry run pytest tests/unit \
        --cov=coder_mcp \
        --cov-report=term-missing \
        --cov-report=xml \
        --cov-report=html \
        -v {posargs}

[testenv:py313-integration]
description = Run integration tests
docker =
    redis
    mock-openai
commands =
    poetry run pytest tests/integration \
        --cov=coder_mcp \
        --cov-append \
        -v {posargs}

[testenv:py313-e2e]
description = Run end-to-end tests
docker =
    redis
    mock-openai
commands =
    poetry run pytest tests/e2e \
        --cov=coder_mcp \
        --cov-append \
        -v {posargs}

[testenv:lint]
description = Run all linting tools
skip_install = True
commands =
    poetry run black --check coder_mcp tests
    poetry run isort --check-only coder_mcp tests
    poetry run flake8 coder_mcp tests
    poetry run pylint coder_mcp
    poetry run pydocstyle coder_mcp

[testenv:format]
description = Format code
skip_install = True
commands =
    poetry run black coder_mcp tests
    poetry run isort coder_mcp tests
    poetry run autoflake --in-place --remove-all-unused-imports -r coder_mcp tests

[testenv:type-check]
description = Run type checking
commands =
    poetry run mypy coder_mcp --strict

[testenv:security]
description = Run security checks
commands =
    poetry run bandit -r coder_mcp -ll
    poetry run safety check
    poetry run pip-audit

[testenv:docs]
description = Build documentation
changedir = docs
commands =
    poetry run sphinx-build -b html . _build/html
    poetry run sphinx-build -b linkcheck . _build/linkcheck

[testenv:coverage-report]
description = Generate coverage report
skip_install = True
deps = coverage[toml]
commands =
    coverage combine
    coverage report
    coverage html
    coverage xml

[testenv:performance]
description = Run performance tests
commands =
    poetry run pytest tests/performance \
        --benchmark-only \
        --benchmark-json=benchmark.json \
        -v {posargs}

[testenv:mutation]
description = Run mutation testing
commands =
    poetry run mutmut run \
        --paths-to-mutate=coder_mcp/ \
        --tests-dir=tests/unit/ \
        --runner="poetry run pytest -x -q"
    poetry run mutmut html

[testenv:clean]
description = Clean all test artifacts
skip_install = True
allowlist_externals =
    rm
    find
commands =
    rm -rf .tox/
    rm -rf .pytest_cache/
    rm -rf .coverage
    rm -rf htmlcov/
    rm -rf .mypy_cache/
    rm -rf reports/
    find . -type d -name __pycache__ -exec rm -rf {} +
    find . -type f -name "*.pyc" -delete

# Test environment configuration
[pytest]
minversion = 8.0
testpaths = tests
python_files = test_*.py *_test.py
python_classes = Test* *Tests
python_functions = test_*
addopts =
    -ra
    --strict-markers
    --strict-config
    --cov-branch
    --cov-report=term-missing:skip-covered
    --cov-fail-under=80

[coverage:run]
source = coder_mcp
branch = True
parallel = True
omit =
    */tests/*
    */venv/*
    */__pycache__/*

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    if TYPE_CHECKING:
    @abstractmethod
precision = 2
show_missing = True
skip_covered = True

[flake8]
max-line-length = 100
extend-ignore = E203,W503
max-complexity = 10
exclude =
    .tox,
    .venv,
    venv,
    __pycache__,
    *.egg-info,
    build,
    dist
per-file-ignores =
    tests/*:S101,S106
    __init__.py:F401

[mypy]
python_version = 3.13
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = True
disallow_incomplete_defs = True
check_untyped_defs = True
disallow_untyped_decorators = True
no_implicit_optional = True
warn_redundant_casts = True
warn_unused_ignores = True
warn_no_return = True
warn_unreachable = True
strict_equality = True
ignore_missing_imports = True

[isort]
profile = black
multi_line_output = 3
include_trailing_comma = True
force_grid_wrap = 0
use_parentheses = True
ensure_newline_before_comments = True
line_length = 100
skip_gitignore = True

[pylint]
max-line-length = 100
disable =
    C0111,  # missing-docstring
    C0103,  # invalid-name
    R0903,  # too-few-public-methods
    R0801,  # duplicate-code
    W0212,  # protected-access
    W0622,  # redefined-builtin
good-names = i,j,k,_,id,ok
extension-pkg-whitelist = pydantic
ignored-modules = cv2,numpy,pandas
