#!/bin/bash
# Pre-commit hook: Reminds AI to check docs and cleanup
#
# This hook does NOT block commits. It only outputs reminders.
# The AI must decide what actions to take.

# Get staged files (files in this commit)
STAGED=$(git diff --cached --name-only)

if [ -z "$STAGED" ]; then
    exit 0
fi

# Categorize changed files
CODE_CHANGED=$(echo "$STAGED" | grep -E '\.(rs|py|toml|nix)$' || true)
SPECS_CHANGED=$(echo "$STAGED" | grep -E '^specs/' || true)
DOCS_CHANGED=$(echo "$STAGED" | grep -E '\.(md|mdc)$' || true)
SRC_STRUCTURE=$(echo "$STAGED" | grep -E '^src/.*/__init__\.py$' || true)
NEW_DIRS=$(echo "$STAGED" | grep -E '^src/sqrl/[^/]+/' | sed 's|/[^/]*$||' | sort -u || true)

# Check for potential test artifacts in staged files
TEST_ARTIFACTS=$(echo "$STAGED" | grep -E '(test_.*\.tmp|\.test\.|_test_output|debug_|tmp_)' || true)

# Check for leftover test files in working directory (not staged)
UNSTAGED_TEST_FILES=$(git ls-files --others --exclude-standard | grep -E '(test_.*\.tmp|\.test\.|_test_output|debug_|tmp_)' 2>/dev/null || true)

# Output reminder
echo ""
echo "=========================================="
echo "PRE-COMMIT: Doc Sync & Cleanup Check"
echo "=========================================="
echo ""
echo "Files in this commit:"
echo "$STAGED" | sed 's/^/  - /'
echo ""

# 1. Doc sync reminders
if [ -n "$CODE_CHANGED" ]; then
    echo "[DOC SYNC] Code files changed:"
    echo "$CODE_CHANGED" | sed 's/^/  - /'
    echo ">> Check if specs/*.md need updates"
    echo ""
fi

if [ -n "$SPECS_CHANGED" ]; then
    echo "[DOC SYNC] Spec files changed:"
    echo "$SPECS_CHANGED" | sed 's/^/  - /'
    echo ">> Check if related code needs updates"
    echo ""
fi

# 2. Structure documentation reminder
if [ -n "$SRC_STRUCTURE" ] || [ -n "$NEW_DIRS" ]; then
    echo "[STRUCTURE] Package structure may have changed:"
    if [ -n "$SRC_STRUCTURE" ]; then
        echo "$SRC_STRUCTURE" | sed 's/^/  - /'
    fi
    if [ -n "$NEW_DIRS" ]; then
        echo "  New directories:"
        echo "$NEW_DIRS" | sed 's/^/    - /'
    fi
    echo ">> Check if specs/ARCHITECTURE.md structure section needs update"
    echo ""
fi

# 3. Test artifact warnings
if [ -n "$TEST_ARTIFACTS" ]; then
    echo "[WARNING] Test artifacts in staged files:"
    echo "$TEST_ARTIFACTS" | sed 's/^/  - /'
    echo ">> Remove test artifacts before committing (DR8)"
    echo ""
fi

if [ -n "$UNSTAGED_TEST_FILES" ]; then
    echo "[CLEANUP] Unstaged test files found:"
    echo "$UNSTAGED_TEST_FILES" | sed 's/^/  - /'
    echo ">> Consider cleaning up test artifacts (DR8)"
    echo ""
fi

echo "=========================================="
echo "Checklist:"
echo "  [ ] Docs in sync with code changes"
echo "  [ ] Structure docs updated if needed"
echo "  [ ] Test artifacts cleaned up"
echo "=========================================="
echo ""

# Always allow commit (exit 0)
# AI decides whether to abort and fix issues
exit 0
